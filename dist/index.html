<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Final Project - Translate from Egg to JS</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="./assets/css/0.styles.f1456810.css" as="style"><link rel="preload" href="./assets/js/app.afdc115c.js" as="script"><link rel="preload" href="./assets/js/2.2c19e274.js" as="script"><link rel="preload" href="./assets/js/7.a8cee4f5.js" as="script"><link rel="prefetch" href="./assets/js/3.79b60fea.js"><link rel="prefetch" href="./assets/js/4.0d8f90e9.js"><link rel="prefetch" href="./assets/js/5.5f81c412.js"><link rel="prefetch" href="./assets/js/6.2f3f3a69.js">
    <link rel="stylesheet" href="./assets/css/0.styles.f1456810.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="./" aria-current="page" class="home-link router-link-exact-active router-link-active"><!----> <span class="site-name">Final Project - Translate from Egg to JS</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="./coverage/lcov-report/index.html" class="nav-link">
  Coverage
</a></div><div class="nav-item"><a href="https://github.com/ULL-ESIT-PL-2122/tfa-sebastian-tamayo-guzman-alu0101131108/packages/1445862" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Package
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ULL-ESIT-PL-2122/tfa-sebastian-tamayo-guzman-alu0101131108.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="./coverage/lcov-report/index.html" class="nav-link">
  Coverage
</a></div><div class="nav-item"><a href="https://github.com/ULL-ESIT-PL-2122/tfa-sebastian-tamayo-guzman-alu0101131108/packages/1445862" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Package
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ULL-ESIT-PL-2122/tfa-sebastian-tamayo-guzman-alu0101131108.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main aria-labelledby="main-title" class="home"><header class="hero"><!----> <h1 id="main-title">
      Final Project - Translate from Egg to JS
    </h1> <p class="description">
      Welcome to your VuePress site
    </p> <!----></header> <!----> <div class="theme-default-content custom content__default"><h1 id="objetivo-de-la-practica"><a href="#objetivo-de-la-practica" class="header-anchor">#</a> Objetivo de la práctica</h1> <p>Se pretende extender las prácticas anteriores de manera que se incluya la capacidad de
traducir de código Egg a código JS. Se añadirán al módulo una serie de funciones para
la traducción, así como una serie de ejecutables. Además, se incluyen varios test que
ponen a prueba el programa a fondo.</p> <h1 id="codigo-fuente-principal"><a href="#codigo-fuente-principal" class="header-anchor">#</a> Código fuente principal</h1> <h2 id="scope-js"><a href="#scope-js" class="header-anchor">#</a> Scope.js</h2> <p>Se ha añadido un fichero nuevo, scope.js. En el se definen y exportan tres funciones que más adelante servirán para poder
comprobar que no se utilizan variables que no hayan sido previamente definidas. Esto se consigue utilizando un hash scope
que contendrá un atributo por cada variable declarada o utilizada en el código. Estos atributos estarán asociados a un objeto
con una serie de flags: declared, used y isParam, que a medida que se analice el AST para generar la traducción será populado
y editado utilizando las funciones setAsUsed() y setAsDeclared().</p> <p>Al terminar de recorrer el AST generando la traducción, se utilizará el método checkDeclarationsIn() para verificar que
todas las variables registradas en scope, hayan sido definidas.</p> <p>El atributo isParam fue añadido para evitar que se definan las variables asociadas a parámetros de funciones o a nombres de atributos
de hashes u objetos. Además, en el guión se propone manejar el scope de manera que se creen distintas instancias de este objeto, relacionadas
por su prototipo, para gestionar varios entornos en los que puedan definirse variables, pero esto no se consiguió implementar.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Symbol Table structure to check the scope.</span>
<span class="token comment">// {</span>
<span class="token comment">//   key is the variable: { declared: true if declared, used: true if used, isParam: true if is a param or property name },</span>
<span class="token comment">//   ...</span>
<span class="token comment">// }</span>

<span class="token keyword">const</span> <span class="token function-variable function">setAsUsed</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">scope<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">declared</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">used</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
  <span class="token keyword">else</span> scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">setAsDeclared</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">scope<span class="token punctuation">,</span> name<span class="token punctuation">,</span> isParameter</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">declared</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">used</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">isParam</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>declared <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>isParam <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">declared</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">used</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>declared <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">return</span> scope<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">checkDeclarationsIn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">localScope<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>localScope<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>localScope<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>declared<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Variable &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is not declared. </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="generatejsforms-js"><a href="#generatejsforms-js" class="header-anchor">#</a> GenerateJSForms.js</h2> <p>En este archivo se crea un hash cuya finalidad será almacenar en él las funciones necesarias para generar el código JS
asociado a funciones de código Egg, cuya ejecución se describe en el hash specialForms y TopEnv.</p> <p>Concretamente se implementa la lógica para traducir nodos de tipo apply cuyo operador sea:</p> <ul><li>Ariméticos / lógicos: '+', '-', '*', '/', '**', '==', '&lt;', '&gt;', '&amp;&amp;' o '||'.</li> <li>print</li> <li>do</li> <li>:=, def o define</li> <li>= o set</li> <li>fun o -&gt;</li> <li>array o arr</li> <li>element</li> <li>object</li> <li>map</li> <li>length</li> <li>while</li> <li>if</li></ul> <p>Por ejemplo, para una función do, se aplica la siguiente lógica para generar el código JS equivalente.</p> <div class="language-js extra-class"><pre class="language-js"><code>generateJSForms<span class="token punctuation">[</span><span class="token string">&quot;do&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> scope</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> argsTranslated <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">arg</span> <span class="token operator">=&gt;</span> arg<span class="token punctuation">.</span><span class="token function">generateJS</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> last <span class="token operator">=</span> argsTranslated<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(()=&gt;{
    </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>argsTranslated<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>last<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    })()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="ast-js"><a href="#ast-js" class="header-anchor">#</a> Ast.js</h2> <p>Este archivo ya desde varias prácticas atrás se utiliza para definir las clases que conformarán
los nodos del AST. De esta manera se definen las clases Value, Word, Apply, y Property.</p> <p>En esta práctica se ha añadido un método generateJS() a cada una. Este método será el encargado de
generar la traducción a JS de un nodo, de manera recursiva. Finalmente este método devuelve una
cadena de texto con código válido de JavaScript que se podrá ejecutar para obtener el mismo resultado
que el código egg inicial que generó el AST.</p> <p>Un ejemplo claro y simple es el generateJS() de la clase Value, pues representa literales numéricos o
de texto, y su equivalente en JS se calcula de manera prácticamente directa.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Value</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">generateJS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Else is a string</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="runtimesupport-js"><a href="#runtimesupport-js" class="header-anchor">#</a> RuntimeSupport.js</h2> <p>En este archivo se crea y exporta un objeto runtimeSupport, que será de ayuda para replicar
el comportamiento de algunas funciones de Egg. En este caso se implementó la función print tal
y como se especifica en el guión, de manera que imprime todos los parámetros y devuelve el primero
en caso de ser único, o el array de parámetros en caso ed haber más de uno.</p> <div class="language-js extra-class"><pre class="language-js"><code>runtimeSupport <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">print</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> processed <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> body <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// Avoids line terminators as \n.</span>
        <span class="token keyword">return</span> body<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Else</span>
      <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>processed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> args<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">?</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> args<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="eggvm-js"><a href="#eggvm-js" class="header-anchor">#</a> Eggvm.js</h2> <p>En este archivo se realizan varias tareas ya descritas en las anteriores prácticas pero lo que se ha
añadido para el objetivo de este proyecto es una función compileToJS() que recibe un nombre de archivo
por parámetro que contenga código egg, para posteriormente generar su AST y a raiz de él generar el
código equivalente en Javascript.</p> <p>Se puede observar que primeramente se crea un objeto TopScope en el que se incluyen todos los atributos de
topEnv, para indicar al programa que variables como true o false ya se encuentran previamente definidas.</p> <p>También cabe destacar que se crea la función template que se encargará de incluir en el código traducido las
dependencias necesarias para que runTimeSupport se pueda utilizar, además de utilizar jsBeautify para
dar una mejor apariencia al código JS resultante.</p> <p>Por último, dentro de la sentencia try(){...} se genera el AST al alimentar al parser con el código de entrada y
transformando el AST de json resultante en un AST cuyos nodos son objetos de las clases definidas en ast.js. Una vez
terminado esto se genera el código JS equivalente utilizando la función generateJS(), pasándole el objeto scope y
se realiza una llamada a checkDeclarationsIn para asegurarse de que todas las variables en uso hayan sido definidas.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">compileToJS</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> topScope <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>topEnv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    topScope<span class="token punctuation">[</span><span class="token string">'$'</span> <span class="token operator">+</span> key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">declared</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">used</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">template</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">declarations<span class="token punctuation">,</span> jsCode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> requires <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    const path = require('path');
    const runtimeSupport = require(path.join('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">', &quot;runtimeSupport&quot;));
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> code <span class="token operator">=</span> declarations<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">var </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>declarations<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>jsCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> jsCode<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">jsBeautify</span><span class="token punctuation">(</span>requires <span class="token operator">+</span> code<span class="token punctuation">,</span> jsBeautifyConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseFromFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tree <span class="token operator">=</span> <span class="token function">json2AST</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> scope <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>topScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> jsCode <span class="token operator">=</span> tree<span class="token punctuation">.</span><span class="token function">generateJS</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Should modify scope so it includes all variables with declared/used flags.</span>
    <span class="token function">checkDeclarationsIn</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> <span class="token string">&quot;In global program&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// This way function parameter declarations are avoided.</span>
    <span class="token keyword">const</span> declarations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scope<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>isParam<span class="token punctuation">)</span> declarations<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">template</span><span class="token punctuation">(</span>declarations<span class="token punctuation">,</span> jsCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="ejecutable"><a href="#ejecutable" class="header-anchor">#</a> Ejecutable</h1> <p>Se incluye un ejecutable nuevo, bin/egg2js.js que se puede utilizar pasándole como parámetro la ubicación de un archivo de texto que
contenga código egg y este imprimirá por la consola su traducción a JS.</p> <ul><li>Ejemplo de uso:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> egg2js example.egg
</code></pre></div><h1 id="tests"><a href="#tests" class="header-anchor">#</a> Tests</h1> <p>Se han incluido varias suites de tests en esta práctica mezclando aquellos tests proporcionados por el profesor en prácticas anteriores con
otros nuevos creados específicamente para esta.</p> <ul><li><p>Primero se ejecutan los test proporcionados para la práctica anterior, cuya finalidad es comprobar que se construyen bien los ASTs y se
pueden evaluar satisfactoriamente.</p></li> <li><p>A continuación se ejecutan tests que comprueban que el código js generado al traducir desde un archivo .egg sea correcto y que el resultado
de ejecutar el código egg coincide con el resultado de ejecutar el código JS. Estos test se dividen en tres partes: Los tests sacados del guión ed la práctica, los tests que comprueban una ejecución correcta y los tests que comprueban la genereración de errores.</p></li></ul> <p>Si se ejecuta el comando npm test se obtiene la siguiente salida:</p> <div class="language-js extra-class"><pre class="language-js"><code>usuario@ubuntu <span class="token operator">~</span><span class="token operator">/</span><span class="token constant">TFA</span><span class="token operator">-</span>Egg<span class="token operator">-</span>to<span class="token operator">-</span><span class="token constant">JS</span> <span class="token punctuation">(</span>master<span class="token punctuation">)</span> $ npm test

<span class="token operator">&gt;</span> @ull<span class="token operator">-</span>esit<span class="token operator">-</span>pl<span class="token operator">-</span><span class="token number">2122</span><span class="token operator">/</span>tfa<span class="token operator">-</span>sebastian<span class="token operator">-</span>tamayo<span class="token operator">-</span>guzman<span class="token operator">-</span>alu0101131108@<span class="token number">1.0</span><span class="token number">.0</span> test
<span class="token operator">&gt;</span> mocha

  runFromFile Related Tests <span class="token operator">-</span> from Extended<span class="token operator">-</span>Egg
    Testing curry
      ✓ testing curry<span class="token operator">-</span>method<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>353ms<span class="token punctuation">)</span>
      ✓ testing curry<span class="token operator">-</span>no<span class="token operator">-</span>method<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>313ms<span class="token punctuation">)</span>
      ✓ testing curry<span class="token operator">-</span>no<span class="token operator">-</span>method<span class="token operator">-</span>cylinder<span class="token operator">-</span>volume<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>297ms<span class="token punctuation">)</span>
    Testing eval and state meta properties from Egg
      ✓ testing specialform<span class="token operator">-</span>property<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>322ms<span class="token punctuation">)</span>
      ✓ testing specialform<span class="token operator">-</span>property<span class="token operator">-</span><span class="token number">2.</span><span class="token function">egg</span> <span class="token punctuation">(</span>293ms<span class="token punctuation">)</span>
      ✓ testing specialform<span class="token operator">-</span>property<span class="token operator">-</span><span class="token number">3.</span><span class="token function">egg</span> <span class="token punctuation">(</span>300ms<span class="token punctuation">)</span>
      ✓ testing specialform<span class="token operator">-</span>property<span class="token operator">-</span><span class="token number">4.</span><span class="token function">egg</span> <span class="token punctuation">(</span>311ms<span class="token punctuation">)</span>
    Testing Maps<span class="token operator">/</span>Hashes
      ✓ testing map<span class="token operator">-</span>colon<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>300ms<span class="token punctuation">)</span>
      ✓ testing map<span class="token operator">-</span>attributes<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>326ms<span class="token punctuation">)</span>
      ✓ testing map<span class="token operator">-</span>sub<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>308ms<span class="token punctuation">)</span>
      ✓ testing map<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>311ms<span class="token punctuation">)</span>
    Calling <span class="token constant">JS</span> Methods from Egg
      ✓ testing method<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>298ms<span class="token punctuation">)</span>
      ✓ testing method2<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>296ms<span class="token punctuation">)</span>
      ✓ testing method3<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>288ms<span class="token punctuation">)</span>
      ✓ testing method<span class="token operator">-</span>concatenation<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>290ms<span class="token punctuation">)</span>
      ✓ testing method<span class="token operator">-</span>sub<span class="token operator">-</span>patching<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>334ms<span class="token punctuation">)</span>
    Egg Objects
      ✓ testing objects<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>299ms<span class="token punctuation">)</span>
      ✓ testing dot<span class="token operator">-</span>obj<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>322ms<span class="token punctuation">)</span>
      ✓ testing dot<span class="token operator">-</span>obj<span class="token operator">-</span><span class="token number">1.</span><span class="token function">egg</span> <span class="token punctuation">(</span>309ms<span class="token punctuation">)</span>
      ✓ testing dot<span class="token operator">-</span>obj<span class="token operator">-</span><span class="token number">2.</span><span class="token function">egg</span> <span class="token punctuation">(</span>308ms<span class="token punctuation">)</span>
      ✓ testing objects<span class="token operator">-</span>set<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>299ms<span class="token punctuation">)</span>
      ✓ testing objects<span class="token operator">-</span>context<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>331ms<span class="token punctuation">)</span>
      ✓ testing bind<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>328ms<span class="token punctuation">)</span>
    Calling <span class="token constant">JS</span> Methods from Egg
      ✓ testing array<span class="token operator">-</span>properties<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>336ms<span class="token punctuation">)</span>
      ✓ testing property<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>302ms<span class="token punctuation">)</span>
      ✓ testing array<span class="token operator">-</span>set<span class="token operator">-</span>property<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>333ms<span class="token punctuation">)</span>
    Regular Expressions <span class="token keyword">in</span> Egg
      ✓ testing regexp<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>326ms<span class="token punctuation">)</span>
      ✓ testing regexp<span class="token operator">-</span>simple<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>348ms<span class="token punctuation">)</span>
      ✓ testing regexp<span class="token operator">-</span>global<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>345ms<span class="token punctuation">)</span>
      ✓ testing regexp<span class="token operator">-</span>escape<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>308ms<span class="token punctuation">)</span>
      ✓ testing regexp<span class="token operator">-</span>bracket<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>324ms<span class="token punctuation">)</span>
    Separated Compilation <span class="token keyword">in</span> Egg
      ✓ testing client<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>304ms<span class="token punctuation">)</span>
    Testing scopes
      ✓ testing scope<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>309ms<span class="token punctuation">)</span>
    Testing set<span class="token operator">:</span> Assigments
      ✓ testing set<span class="token operator">-</span>simple<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>318ms<span class="token punctuation">)</span>
      ✓ testing one<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>311ms<span class="token punctuation">)</span>
      ✓ testing array<span class="token operator">-</span>set<span class="token operator">-</span>index<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>326ms<span class="token punctuation">)</span>
      ✓ testing set<span class="token operator">-</span>array<span class="token operator">-</span>negative<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>296ms<span class="token punctuation">)</span>
      ✓ testing set<span class="token operator">-</span>error<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>323ms<span class="token punctuation">)</span>
      ✓ testing map<span class="token operator">-</span>set<span class="token operator">-</span>index<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>329ms<span class="token punctuation">)</span>
      ✓ testing leftvalue<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>313ms<span class="token punctuation">)</span>
    Testing strings
      ✓ testing string<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>324ms<span class="token punctuation">)</span>
      ✓ testing string<span class="token operator">-</span>apply<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>302ms<span class="token punctuation">)</span>
      ✓ testing string<span class="token operator">-</span>index<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>342ms<span class="token punctuation">)</span>
      ✓ testing map<span class="token operator">-</span>set<span class="token operator">-</span>index<span class="token punctuation">.</span><span class="token function">egg</span> <span class="token punctuation">(</span>312ms<span class="token punctuation">)</span>
    Tests <span class="token keyword">with</span> console<span class="token punctuation">.</span>log mocking
      ✓ testing one<span class="token punctuation">.</span>egg <span class="token keyword">with</span> mocking <span class="token keyword">of</span> console<span class="token punctuation">.</span>log
      ✓ testing array<span class="token punctuation">.</span>egg <span class="token keyword">with</span> mocking <span class="token keyword">of</span> console<span class="token punctuation">.</span>log
      ✓ testing <span class="token keyword">if</span><span class="token punctuation">.</span>egg <span class="token keyword">with</span> mocking <span class="token keyword">of</span> console<span class="token punctuation">.</span>log
      ✓ testing reduce<span class="token punctuation">.</span>egg <span class="token keyword">with</span> mocking <span class="token keyword">of</span> console<span class="token punctuation">.</span>log

  CompileToJS Related Tests
    My tests
      ✓ Translation <span class="token operator">-</span> simple<span class="token operator">-</span>def<span class="token operator">-</span><span class="token keyword">set</span>
      ✓ Execution <span class="token operator">-</span> simple<span class="token operator">-</span>def<span class="token operator">-</span><span class="token keyword">set</span>
      ✓ Translation <span class="token operator">-</span> literal<span class="token operator">-</span>print
      ✓ Execution <span class="token operator">-</span> literal<span class="token operator">-</span>print
      ✓ Translation <span class="token operator">-</span> <span class="token keyword">if</span>
      ✓ Execution <span class="token operator">-</span> <span class="token keyword">if</span>
      ✓ Translation <span class="token operator">-</span> array<span class="token operator">-</span>currying
      ✓ Execution <span class="token operator">-</span> array<span class="token operator">-</span>currying
      ✓ Translation <span class="token operator">-</span> array<span class="token operator">-</span>access
      ✓ Execution <span class="token operator">-</span> array<span class="token operator">-</span>access
      ✓ Translation <span class="token operator">-</span> array<span class="token operator">-</span>nested<span class="token operator">-</span>elem
      ✓ Execution <span class="token operator">-</span> array<span class="token operator">-</span>nested<span class="token operator">-</span>elem
      ✓ Translation <span class="token operator">-</span> array<span class="token operator">-</span>length
      ✓ Execution <span class="token operator">-</span> array<span class="token operator">-</span>length
      ✓ Translation <span class="token operator">-</span> map
      ✓ Execution <span class="token operator">-</span> map
    Task description examples tests
      ✓ Translation <span class="token operator">-</span> times
      ✓ Execution <span class="token operator">-</span> times
      ✓ Translation <span class="token operator">-</span> string
      ✓ Execution <span class="token operator">-</span> string
      ✓ Translation <span class="token operator">-</span> funfun
      ✓ Execution <span class="token operator">-</span> funfun
      ✓ Translation <span class="token operator">-</span> <span class="token keyword">do</span>
      ✓ Execution <span class="token operator">-</span> <span class="token keyword">do</span>
      ✓ Translation <span class="token operator">-</span> declared<span class="token operator">-</span>twice
      ✓ Execution <span class="token operator">-</span> declared<span class="token operator">-</span>twice
      ✓ Translation <span class="token operator">-</span> <span class="token keyword">while</span>
      ✓ Execution <span class="token operator">-</span> <span class="token keyword">while</span>
    My error tests
      ✓ Error <span class="token operator">-</span> not<span class="token operator">-</span>implemented
      ✓ Error <span class="token operator">-</span> set<span class="token operator">-</span>error


  <span class="token number">78</span> <span class="token function">passing</span> <span class="token punctuation">(</span>14s<span class="token punctuation">)</span>
</code></pre></div></div> <div class="footer">
    Made by  with ❤️
  </div></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.afdc115c.js" defer></script><script src="/assets/js/2.2c19e274.js" defer></script><script src="/assets/js/7.a8cee4f5.js" defer></script>
  </body>
</html>
